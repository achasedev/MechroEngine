///--------------------------------------------------------------------------------------------------------------------------------------------------
/// Author: Andrew Chase
/// Date Created: March 18, 2021
/// Description: 
///--------------------------------------------------------------------------------------------------------------------------------------------------

///--------------------------------------------------------------------------------------------------------------------------------------------------
/// INCLUDES
///--------------------------------------------------------------------------------------------------------------------------------------------------
#include "Engine/Collision/3D/Collider3d.h"
#include "Engine/Framework/EngineCommon.h"
#include "Engine/Math/Transform.h"
#include "Engine/Render/Core/RenderContext.h"

///--------------------------------------------------------------------------------------------------------------------------------------------------
/// DEFINES
///--------------------------------------------------------------------------------------------------------------------------------------------------
RTTI_TYPE_DEFINE(Collider3d);
RTTI_TYPE_DEFINE(SphereCollider3d);
RTTI_TYPE_DEFINE(CapsuleCollider3d);
RTTI_TYPE_DEFINE(PolytopeCollider3d);

///--------------------------------------------------------------------------------------------------------------------------------------------------
/// ENUMS, TYPEDEFS, STRUCTS, FORWARD DECLARATIONS
///--------------------------------------------------------------------------------------------------------------------------------------------------
class Material;

///--------------------------------------------------------------------------------------------------------------------------------------------------
/// GLOBALS AND STATICS
///--------------------------------------------------------------------------------------------------------------------------------------------------

///--------------------------------------------------------------------------------------------------------------------------------------------------
/// C FUNCTIONS
///--------------------------------------------------------------------------------------------------------------------------------------------------

///--------------------------------------------------------------------------------------------------------------------------------------------------
/// CLASS IMPLEMENTATIONS
///--------------------------------------------------------------------------------------------------------------------------------------------------


//-------------------------------------------------------------------------------------------------
Sphere3d SphereCollider3d::GetWorldShape()
{
	Vector3 positionWs = m_bounds.m_center;
	positionWs = m_transform.TransformPoint(positionWs);
	
	return Sphere3d(positionWs, m_bounds.m_radius);
}


//-------------------------------------------------------------------------------------------------
PolytopeCollider3d::PolytopeCollider3d(const OBB3& boxShape)
{
	// TODO: Put shapes into the collision system
	m_shapeLs = new Polygon3d(boxShape);
}


//-------------------------------------------------------------------------------------------------
PolytopeCollider3d::PolytopeCollider3d(const Polygon3d* shape)
{
	m_shapeLs = new Polygon3d();
	*m_shapeLs = *shape;

	if (!m_shapeLs->HasGeneratedHalfEdges())
	{
		m_shapeLs->GenerateHalfEdgeStructure();
	}
}


//-------------------------------------------------------------------------------------------------
void PolytopeCollider3d::DebugRender(const Rgba& color, Shader* shader /*= nullptr*/)
{
	// Debug render in world space
	g_renderContext->DrawWirePolygon3D(m_shapeWs, color, shader);
}


//-------------------------------------------------------------------------------------------------
void PolytopeCollider3d::SetShape(Polygon3d* shape)
{
	m_shapeLs = shape;
}


//-------------------------------------------------------------------------------------------------
const Polygon3d* PolytopeCollider3d::GetLocalShape() const
{
	return m_shapeLs;
}


//-------------------------------------------------------------------------------------------------
const Polygon3d* PolytopeCollider3d::GetWorldShape() const
{
	return &m_shapeWs;
}


//-------------------------------------------------------------------------------------------------
void PolytopeCollider3d::GenerateWorldShape()
{
	Matrix44 worldMat = m_transform.GetLocalToWorldMatrix();
	m_shapeLs->GetTransformed(worldMat, m_shapeWs);
}
