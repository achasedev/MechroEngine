///--------------------------------------------------------------------------------------------------------------------------------------------------
/// Author: Andrew Chase
/// Date Created: April 24th, 2021
/// Description: 
///--------------------------------------------------------------------------------------------------------------------------------------------------

///--------------------------------------------------------------------------------------------------------------------------------------------------
/// INCLUDES
///--------------------------------------------------------------------------------------------------------------------------------------------------
#include "Engine/Core/EngineCommon.h"
#include "Engine/Math/Vector3.h"
#include "Engine/Physics/Particle/Particle.h"
#include "Engine/Physics/Particle/ParticleBungee.h"

///--------------------------------------------------------------------------------------------------------------------------------------------------
/// DEFINES
///--------------------------------------------------------------------------------------------------------------------------------------------------

///--------------------------------------------------------------------------------------------------------------------------------------------------
/// ENUMS, TYPEDEFS, STRUCTS, FORWARD DECLARATIONS
///--------------------------------------------------------------------------------------------------------------------------------------------------

///--------------------------------------------------------------------------------------------------------------------------------------------------
/// GLOBALS AND STATICS
///--------------------------------------------------------------------------------------------------------------------------------------------------

///--------------------------------------------------------------------------------------------------------------------------------------------------
/// C FUNCTIONS
///--------------------------------------------------------------------------------------------------------------------------------------------------

///--------------------------------------------------------------------------------------------------------------------------------------------------
/// CLASS IMPLEMENTATIONS
///--------------------------------------------------------------------------------------------------------------------------------------------------


//-------------------------------------------------------------------------------------------------
ParticleBungee::ParticleBungee(Particle* endParticle, float springConstant, float restLength)
	: m_endParticle(endParticle)
	, m_springConstant(springConstant)
	, m_restLength(restLength)
{
}


//-------------------------------------------------------------------------------------------------
void ParticleBungee::GenerateAndApplyForce(Particle* particle, float deltaSeconds) const
{
	UNUSED(deltaSeconds);

	// Get the force direction, pointing from the end to this particle
	Vector3 forceDir = particle->GetPosition() - m_endParticle->GetPosition();
	float springLength = forceDir.SafeNormalize(forceDir);

	if (springLength > 0.f)
	{
		// Ensure the spring is stretched, don't apply force from compression
		float deltaLength = (springLength - m_restLength);
		if (deltaLength > 0.f)
		{
			// Determine magnitude based on length and resting length
			float magnitude = deltaLength * m_springConstant;

			// Apply the force
			particle->AddForce(forceDir * -magnitude);
		}
	}
}
