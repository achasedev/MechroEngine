///--------------------------------------------------------------------------------------------------------------------------------------------------
/// Author: Andrew Chase
/// Date Created: April 26th, 2021
/// Description: 
///--------------------------------------------------------------------------------------------------------------------------------------------------

///--------------------------------------------------------------------------------------------------------------------------------------------------
/// INCLUDES
///--------------------------------------------------------------------------------------------------------------------------------------------------
#include "Engine/Core/EngineCommon.h"
#include "Engine/Physics/Particle/ParticleContact.h"
#include "Engine/Physics/Particle/ParticleContactResolver.h"

///--------------------------------------------------------------------------------------------------------------------------------------------------
/// DEFINES
///--------------------------------------------------------------------------------------------------------------------------------------------------

///--------------------------------------------------------------------------------------------------------------------------------------------------
/// ENUMS, TYPEDEFS, STRUCTS, FORWARD DECLARATIONS
///--------------------------------------------------------------------------------------------------------------------------------------------------

///--------------------------------------------------------------------------------------------------------------------------------------------------
/// GLOBALS AND STATICS
///--------------------------------------------------------------------------------------------------------------------------------------------------

///--------------------------------------------------------------------------------------------------------------------------------------------------
/// C FUNCTIONS
///--------------------------------------------------------------------------------------------------------------------------------------------------

///--------------------------------------------------------------------------------------------------------------------------------------------------
/// CLASS IMPLEMENTATIONS
///--------------------------------------------------------------------------------------------------------------------------------------------------


//-------------------------------------------------------------------------------------------------
ParticleContactResolver::ParticleContactResolver(int maxIterations)
	: m_maxIterations(maxIterations)
{
}


//-------------------------------------------------------------------------------------------------
void ParticleContactResolver::ResolveContacts(ParticleContact* contacts, int numContacts, float deltaSeconds)
{
	for (int iteration = 0; iteration < m_maxIterations; ++iteration)
	{
		// Find the greatest closing velocity (most negative separating velocity)
		float minSepVelocity = FLT_MAX;
		int minIndex = -1;

		for (int contactIndex = 0; contactIndex < numContacts; ++contactIndex)
		{
			float sepVelocity = contacts[contactIndex].CalculateSeparatingVelocity();
			if (sepVelocity < minSepVelocity && (sepVelocity < 0.f || contacts[contactIndex].GetPenetration() > 0.f))
			{
				minSepVelocity = sepVelocity;
				minIndex = contactIndex;
			}
		}

		if (minIndex < 0)
			break;

		contacts[minIndex].Resolve(deltaSeconds);
	}
}
